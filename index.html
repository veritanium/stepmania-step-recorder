<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-gray-600">
        <div class="mx-96" id="main-div">
            <div id="header" class="flex justify-center h-32">
                <h1 class="">Step Recorder</h1>
            </div>
            <div id="content" class="flex justify-center">
                <div class="flex-col space-y-2">
                    <div>
                        <label for="beats_per_min">BPM</label>
                        <input id="beats_per_min" name="beats_per_min" type="number" value="120">
                    </div>
                    <hr />
                    <div class="flex-col">
                        <div class="flex">
                            <input id="dancepad" name="key_input_type" value="dancepad" type="checkbox" disabled>
                            <label for="dancepad" class="ml-4">Dance Pad</label>
                        </div>
                    </div>
                    <hr />
                    <div class="flex justify-center">
                        <button type="button" id="start_btn" class="bg-green-600 px-8 py-1 rounded-md">Start</button>
                        <button type="button" id="stop_btn" class="bg-red-600 px-8 py-1 rounded-md hidden">Stop</button>
                    </div>
                    <div class="flex justify-center">
                        <span id="start_message" class="bg-red-400 p-2 rounded-md hidden"></span>
                    </div>
                    <div>
                        <button type="button" id="show_btn" class="bg-yellow-600 px-8 py-1 rounded-md">Show Recorded Steps</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            /**
             * This is a proof-of-concept to create a step mania step recorder for song step creation
             * It is supposed to generate the step part of an sm file as defined here:
             * https://github.com/stepmania/stepmania/wiki/sm 
             * 
             */

            // ================== Helper methods
            function getEl(id) {
                return document.getElementById(id)
            }

            function getBeatsPerMin() {
                return getEl('beats_per_min').value;
            }

            function enableKeyBoardEvents() {
                document.addEventListener('keydown', handleKeyDown);
                document.addEventListener('keyup', handleKeyUp);
            }

            function disableKeyBoardEvents() {
                document.removeEventListener('keydown', handleKeyDown);
                document.removeEventListener('keyup', handleKeyUp);
            }

            function canGame() {
                return "getGamepads" in navigator;
            }

            function canStart() {
                // check if beats per minute is set
                return !!getBeatsPerMin();
            }

            function showError(message) {
                let startMessage = getEl('start_message');
                startMessage.textContent = message;
                startMessage.classList.remove('hidden');
            }

            function hideError() {
                getEl('start_message').classList.add('hidden');
            }

            function toggleBtns() {
                let startBtn = getEl('start_btn');
                let stopBtn = getEl('stop_btn');
                if (startBtn.classList.contains('hidden')) {
                    startBtn.classList.remove('hidden');
                    stopBtn.classList.add('hidden');
                } else {
                    startBtn.classList.add('hidden');
                    stopBtn.classList.remove('hidden');
                }
            }

            function getBeatSeconds() {
                let bpm = getBeatsPerMin();

                if (bpm) {
                    let secondsPerBeat = 1.0 / (bpm / 60);
                    return {
                        quarter: secondsPerBeat,
                        eighth: secondsPerBeat / 2,
                        sixteenth: secondsPerBeat / 4, 
                    }
                }

                return false;
            }

            function mergeSteps(step1, step2) {
                return (parseInt(step1, 2) + parseInt(step2, 2)).toString(2);
            }

            function convertKeyToStep(key) {
                return SM_KEY_NOTES[key];
            }

            // ================== Game pad handling
            // https://developer.mozilla.org/en-US/docs/Web/API/Gamepad_API/Using_the_Gamepad_API
            function handleGamePadEvent(event) {
                console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",
                    event.gamepad.index, event.gamepad.id,
                    event.gamepad.buttons.length, event.gamepad.axes.length);
            };

            // Event listeners
            getEl('start_btn').addEventListener('click', runStart);
            getEl('stop_btn').addEventListener('click', runStop);
            getEl('show_btn').addEventListener('click', processRecording);

            window.addEventListener('gamepadconnected', handleGamePadEvent);

            // ================== Init vars
            let recorder;
            const INPUT_KEY_CODES = {
                'ArrowUp': 'u',
                'ArrowDown': 'd',
                'ArrowLeft': 'l',
                'ArrowRight': 'r',
                'Numpad8': 'u',
                'Numpad2': 'd',
                'Numpad4': 'l',
                'Numpad6': 'r',
            };

            const SM_KEY_NOTES = {
                l: '1000',
                r: '0001',
                u: '0100',
                d: '0010', 
            }

            let currentKeysPressed = new Set();

            let currentRecordingMeasure = 1;
            let currentRecordingBeat = 1;

            let recording = new Set();
            let stepRecording = {
                '1': ['0000'],
            };

            // options are 4, 8, 16
            const STANDARD_BEAT_NOTE = 16;

            // ================== Main methods
            function runStart() {
                hideError();
                
                if (!canStart()) {
                    showError('Beats per minute must be set');
                    return;
                }
                toggleBtns();
                
                // get beats per min
                beatDurations = getBeatSeconds();

                // get input type

                console.log('can game', canGame());

                enableKeyBoardEvents();

                // start recording
                startRecorder(beatDurations);
            }

            function startRecorder({ quarter, eighth, sixteenth }) {
                // assume 4 beats per measure and sample at the sixteenth note level
                recorder = setInterval(handleStepInterval, sixteenth * 1000);
            }

            function handleStepInterval() {
                currentRecordingBeat++;
                if (currentRecordingBeat % (STANDARD_BEAT_NOTE + 1) === 0) {
                    currentRecordingBeat = 1;
                    currentRecordingMeasure++;
                    stepRecording[currentRecordingMeasure] = [];
                }

                let currentKeys = [...currentKeysPressed.values()];

                // check if any keys are currently pressed
                if (currentKeys.length) {
                    if (currentKeys.length === 1) {
                        stepRecording[currentRecordingMeasure].push(convertKeyToStep(currentKeys[0]));
                    } else if (currentKeys.length === 2) {
                        stepRecording[currentRecordingMeasure].push(mergeSteps(convertKeyToStep(currentKeys[0]), convertKeyToStep(currentKeys[1])));
                    }
                } else {
                    // set a zero measure
                    stepRecording[currentRecordingMeasure].push('0000');
                }
 
            }

            function runStop() {
                stopRecorder();
                disableKeyBoardEvents();
                toggleBtns();
            }

            function stopRecorder() {
                clearInterval(recorder);
            }

            function handleKeyDown(event) {    
                if (event.code === 'Escape') {
                    runStop();
                    return;
                }

                // set keys currently held
                currentKeysPressed.add(INPUT_KEY_CODES[event.code]);

                // old method
                recording.add(`${INPUT_KEY_CODES[event.code]}-${currentRecordingMeasure}-${currentRecordingBeat}`);
            }

            function handleKeyUp(event) {
                currentKeysPressed.delete(INPUT_KEY_CODES[event.code]);
            }

            function processRecording() {
                // assume 4 beats per measure

                let recordCopy = [...recording.values()];

                console.log(recordCopy);
                console.log(stepRecording);

                // while recording array still has records create the beats
                const LOOP_LIMIT = 1000;
                let loopCount = 0;
                let copyMeasureCount = 1;
                let copyBeat = 1;
                let recordedBeats = {};
                let currentMeasure = [];

                while(recordCopy.length > 0 && loopCount < LOOP_LIMIT) {
                    let currentStep = recordCopy[0];
                    let nextStep = recordCopy[0];

                    let [currentKey, currentMeasureCount, currentBeat] = currentStep.split('-');
                    let [nextKey, nextMeasure, nextBeat] = nextStep.split('-');

                    if (copyMeasureCount < currentMeasureCount) {
                        if (currentMeasure.length) {
                            currentMeasure.map(beat => {
                                // TODO this needs to be rewritten
                                recordedBeats += `${beat.step}\n`;
                            });
                        } else {
                            recordedBeats += '0000\n0000\n0000\n0000\n,\n';
                        }
                        copyMeasureCount++;
                    } else {
                        if (nextKey) {
                            // if next step is identical except the arrow key then make a double step
                            if (currentKey !== nextKey && nextBeat === currentBeat) {
                                currentMeasure.push({
                                    step: mergeNotes(SM_KEY_NOTES[currentKey], SM_KEY_NOTES[nextKey]),
                                    beat: currentBeat
                                });
                                // extra shift to take account of double step
                                recordCopy.shift();
                            } else  {
                                // if next step is 4 or more beats away than make 1/4 note
                                let duration = 4;
                                // if next step is less than 4 but greater than 2 beats away then make 1/8 note
                                if (nextBeat - currentBeat > 2) {
                                    duration = 8;
                                } else {
                                    // if next step is less than or equal to 2 than make 1/16 note
                                    duration = 16;
                                }
                                currentMeasure.push({
                                    step: convertNoteToStep(SM_KEY_NOTES[currentKey]),
                                    beat: currentBeat,
                                    duration,
                                });
                            }
                            
                        } else {
                            currentMeasure.push({
                                step: convertNoteToStep(SM_KEY_NOTES[currentKey]),
                                beat: currentBeat,
                                duration: 4,
                            });
                        }
                        recordCopy.shift();
                    }


                    loopCount++;
                }
                console.log(loopCount);

                console.log(recordedBeats);
            }

        </script>
    </body>
</html>